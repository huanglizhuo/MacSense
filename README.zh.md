# Apple Motion

一款原生 SwiftUI macOS 仪表盘，实时读取 Apple Silicon MacBook 内置 MEMS IMU（加速度计 + 陀螺仪）、环境光传感器和合盖角度传感器 —— 无需 root 权限、无需 Python 运行时、无第三方依赖。

> **硬件要求：** Apple Silicon MacBook（M1 / M2 / M3 / M4）。
> `AppleSPUHIDDevice` 在 Intel Mac 或桌面版 Apple Silicon 设备上不存在。

---

## 界面预览

```
┌──────────────────────────────────────────────────────────────┐
│ ● AppleSPUHIDDevice   合盖 118°   ☀ 320 lx                   │
├─────────────────────────┬────────────────────────────────────┤
│  加速度计 (g)            │  姿态角                            │
│  ───────────────────    │  横滚  +12.3°  ████████░░░░       │
│  X ─────────────────    │  俯仰  -4.1°   ████░░░░░░░░       │
│  Y ─────────────────    │  偏航  +87.6°  █████████░░░       │
│  Z ─────────────────    │                                    │
│                         │  [人工地平仪]                       │
│  陀螺仪 (°/s)            ├────────────────────────────────────┤
│  X ─────────────────    │  振动频谱                           │
│  Y ─────────────────    │  ▄ ▂ █ ▃ ▁  3/6/12/25/50 Hz      │
│  Z ─────────────────    ├────────────────────────────────────┤
│                         │  事件日志                           │
│                         │  VIBRATION  12:34:05  0.0312 g    │
│                         │  MICRO-VIB  12:33:58  0.0041 g    │
└─────────────────────────┴────────────────────────────────────┘
```

---

## 传感器数据说明

### 1. 加速度计 — `accel: SIMD3<Float>`（单位：**g**，1 g ≈ 9.8 m/s²）

测量设备所受的**比力**，即所有非引力之和加上对重力的反作用力，除以质量。

| 轴 | 物理方向 | 静置典型值 |
|----|---------|-----------|
| X | 键盘横向，左 ← → 右 | ≈ 0 g |
| Y | 前后方向，朝向铰链 / 远离铰链 | ≈ 0 g |
| Z | 垂直方向，向下 ↔ 向上 | ≈ −1 g（重力反作用） |

**要点：**
- **水平静置时：** az ≈ −1 g。这是 Apple Silicon SPU 的坐标约定 —— 重力分量出现在 −Z 轴，与许多 Android 设备相反（Android 通常为 +Z = +1 g）。
- **倾斜时：** 重力的约 1 g 分量会在 X / Y / Z 三轴之间重新分配。
- **振动时：** 在重力基线之上叠加快速、小幅波动。
- **原始采样率：** 约 800 Hz；经 **8∶1 抽取**后降至约 **100 Hz** 再进行处理。
- **报告格式：** 22 字节 HID 报告；三个 `int32` 小端值，分别位于字节偏移 6 / 10 / 14；除以 65 536（Q16 定点数）得到以 g 为单位的浮点值。

---

### 2. 陀螺仪 — `gyro: SIMD3<Float>`（单位：**°/s**）

测量设备的**角速度** —— 以多快的速度绕哪个轴旋转。

| 轴 | 对应旋转 |
|----|---------|
| X | 俯仰（Pitch）—— 屏幕向前 / 向后倾斜 |
| Y | 横滚（Roll）—— 设备向左 / 向右侧翻 |
| Z | 偏航（Yaw）—— 设备在水平面内旋转 |

**要点：**
- 静置时三轴均接近 0 °/s（加上少量电子噪声底噪）。
- 陀螺仪存在累积漂移；Mahony AHRS 用加速度计的重力参考对其进行持续校正。
- 与加速度计采用相同的 22 字节报告格式和 Q16 缩放系数。
- 同样进行 8∶1 抽取，输出约 100 Hz。

---

### 3. 姿态角 — 横滚 / 俯仰 / 偏航（单位：**°**）

由 **Mahony AHRS**（姿态航向参考系统）融合加速度计和陀螺仪数据计算得出。该算法基于四元数，能抑制陀螺仪漂移并提供稳定的姿态角。

```
              +俯仰（屏幕前倾）
                    ↑
   +横滚 ←──── MacBook ────→ −横滚
   （左倾）                   （右倾）
                    ↓
              −俯仰（屏幕后倾）
```

| 角度 | 范围 | 含义 |
|------|------|------|
| **横滚（Roll）** | −180° … +180° | 绕前后轴旋转。0° = 水平；+90° = 右侧朝下 |
| **俯仰（Pitch）** | −90° … +90° | 绕左右轴旋转。0° = 水平；+90° = 屏幕朝上 |
| **偏航（Yaw）** | −180° … +180° | 绕垂直轴旋转，相对于开机方向的方位角。无磁力计，会缓慢漂移 |

**算法参数（与 Python 参考实现一致）：**
- 比例增益 `kp = 1.0` —— 控制加速度计修正陀螺仪的力度。
- 积分增益 `ki = 0.05` —— 消除陀螺仪的稳态偏置误差。
- 四元数由**首帧加速度计读数直接引导初始化**，横滚 / 俯仰立即准确，无需等待约 10 秒的收敛期。
- 叉积误差使用 `v × a`（而非 `a × v`），因为 Apple Silicon SPU 将重力报告在 −Z 轴上。

---

### 4. 振动频谱 — 5 个频带（单位：**满量程百分比**）

使用对高通滤波后加速度模值的一阶 IIR 包络跟踪器，估计机械振动在五个频带上的能量分布。

| 频带 | 中心频率 | 典型振动来源 |
|------|---------|------------|
| 频带 1 | ~3 Hz | 人体运动、低速机械振荡、风扇不平衡 |
| 频带 2 | ~6 Hz | 桌面 / 地板共振模式、键盘回弹 |
| 频带 3 | ~12 Hz | 电机振动、HVAC 风管 |
| 频带 4 | ~25 Hz | 硬盘启动（旧系统）、压缩机 |
| 频带 5 | ~50 Hz | 市电频率电气振动、高速电机 |

**计算流程：**
1. **高通 IIR 滤波器**（α = 0.95，截止频率 ≈ 0.16 Hz）去除静态重力分量，保留动态加速度。
2. 计算滤波后三轴向量的**模值**（每个样本）。
3. 五个具有不同时间常数的**包络跟踪器**分别追踪各频带能量。
4. 结果转换为对数刻度（类 dB），归一化为 0–100%。

---

### 5. 环境光传感器（ALS）— `alsLux` / `alsChannels`

ALS 通过 SPU 子系统内置的多光谱光电探测器阵列测量**环境照度**。

| 字段 | 单位 | 含义 |
|------|------|------|
| `alsLux` | 勒克斯（lx） | 经过校准的环境光亮度 |
| `alsChannels[0]` | 原始计数 | 光谱通道 0（通常为可见光蓝色波段） |
| `alsChannels[1]` | 原始计数 | 光谱通道 1（通常为可见光绿色波段） |
| `alsChannels[2]` | 原始计数 | 光谱通道 2（通常为可见光红色波段） |
| `alsChannels[3]` | 原始计数 | 光谱通道 3（通常为近红外波段） |

**要点：**
- 122 字节 HID 报告；4 个通道为 `uint32` 小端，位于字节偏移 20 / 24 / 28 / 32；亮度为 `float32` 小端，位于偏移 40。
- HID Usage Page `0xFF00`，Usage `4`。
- macOS 使用此传感器自动调节显示亮度；此应用读取不会干扰系统行为。

**常见环境照度参考值：**

| 场景 | 典型照度 |
|------|---------|
| 暗室 | < 10 lx |
| 办公室照明 | 300–500 lx |
| 阴天室外 | 1 000–10 000 lx |
| 直射阳光 | > 50 000 lx |

---

### 6. 合盖角度 — `lidAngle`（单位：**°**）

报告 MacBook 屏幕的**开合角度**，由铰链处的霍尔效应传感器或机械传感器测量。

| 数值 | 状态 |
|------|------|
| 0° | 完全合盖 |
| ~115–120° | 正常使用（打字）姿态 |
| ~180° | 完全展开（平铺） |
| 最大 511° | 原始传感器量程上限（9 位） |

**要点：**
- 3 字节 HID 报告；字节 0 必须等于 `1`（报告 ID 有效性校验）；角度为 9 位 `uint16` 小端，位于字节 1–2（`raw & 0x1FF`）。
- HID Usage Page `0x0020`（HID 传感器页），Usage `138`。
- macOS 据此管理键盘背光、显示器休眠和合盖模式。

---

## 振动事件检测

四种独立算法以约 100 Hz 的频率并行运行，检测机械扰动。

### 算法 1 — STA/LTA（短时均值 / 长时均值比）

通过比较快速滑动均值（STA）与慢速滑动均值（LTA）来检测**突发能量增加**。同时运行三个时间尺度：

| 时间尺度 | STA 窗口 | LTA 窗口 | 触发阈值 | 释放阈值 |
|---------|---------|---------|---------|---------|
| 快速 | 3 样本（30 ms） | 100 样本（1 s） | > 3.0 | < 1.5 |
| 中速 | 15 样本（150 ms） | 500 样本（5 s） | > 2.5 | < 1.3 |
| 慢速 | 50 样本（500 ms） | 2 000 样本（20 s） | > 2.0 | < 1.2 |

- 使用**能量**（模值²）而非幅值，对宽频事件更敏感。
- 独立的触发 / 释放阈值（迟滞机制）防止快速重复触发。

### 算法 2 — CUSUM（累积和控制图）

检测**持续的电平偏移** —— 在多个样本上缓慢累积的振动变化。

- 以极慢的指数移动平均追踪基线（`mu += 0.0001 × (mag − mu)`）。
- 同时维护正向累积量（`cusumPos`）和负向累积量（`cusumNeg`），均在基线上方计算。
- 任一累积量超过判决阈值（`h = 0.01`）时触发，随即重置。
- 双向设计能同时捕捉振动增强和减弱两种情形。

### 算法 3 — 峰度（Kurtosis）

检测**冲击性非高斯事件**，例如锐利的敲击或碰撞。

- 维护 100 个样本（1 s）的滑动窗口。
- 计算四阶标准化中心矩：`K = E[(x−μ)⁴] / E[(x−μ)²]²`。
- 高斯噪声的峰度 K ≈ 3；锐利冲击会将 K 推高到阈值 **6** 以上。

### 算法 4 — Peak / MAD（中位绝对偏差）

基于鲁棒噪声估计，检测相对于近期背景水平的**统计离群值**。

- 维护 200 个样本（2 s）的窗口。
- 计算中位数和 MAD：`σ_鲁棒 = 1.4826 × median(|x − median|)`。
- 按当前样本偏离中位数的鲁棒标准差倍数分级：

| 偏差倍数 | 标签 |
|---------|------|
| ≥ 2σ | MICRO（微型） |
| ≥ 3.5σ | MOYEN（中等） |
| ≥ 5σ | FORT（强烈） |
| ≥ 8σ | MAJEUR（主要） |

---

## 事件严重度分级

每个采样帧综合四种检测器的输出，按同时触发的检测器数量和峰值加速度幅值进行分级：

| 严重度 | 触发条件 | 颜色 |
|--------|---------|------|
| **CHOC-MAJEUR（主要冲击）** | ≥ 4 个检测器触发，且幅值 > 50 mg | 🔴 红色 |
| **CHOC-MOYEN（中等冲击）** | ≥ 3 个检测器触发，且幅值 > 20 mg | 🟠 橙红色 |
| **MICRO-CHOC（微型冲击）** | Peak/MAD 触发，且幅值 > 5 mg | 🟠 橙色 |
| **VIBRATION（振动）** | STA/LTA 或 CUSUM 触发，且幅值 > 3 mg | 🟡 黄色 |
| **VIB-LÉGÈRE（轻微振动）** | 任意检测器触发，且幅值 > 1 mg | 🔵 青色 |
| **MICRO-VIB（微振动）** | 任意检测器触发，幅值 ≤ 1 mg | ⚪ 灰色 |

事件日志显示时间戳、严重度徽章、峰值加速度和触发检测器标签（如 `STA/LTA · CUSUM`）。

---

## 架构

```
AppleSPUHIDDriver（启动时通过 IOServiceMatching 唤醒）
        │
        ▼
AppleSPUHIDDevice（匹配 4 个 HID 设备）
  ├── usage 3           → 加速度计（22 B，~800 Hz，8∶1 → 100 Hz）
  ├── usage 9           → 陀螺仪  （22 B，~800 Hz，8∶1 → 100 Hz）
  ├── usage 4           → ALS 环境光（122 B，快照）
  └── usage 138（page 0x0020）→ 合盖角度（3 B，快照）
        │
        ▼
SensorManager（IOHIDManager，主 RunLoop，回调在主线程）
        │
        ▼
SignalProcessor（每样本同步处理）
  ├── HighPassFilter    α=0.95 → 去除重力基线
  ├── MahonyAHRS        kp=1.0，ki=0.05，从重力引导初始四元数
  ├── IIR 频谱          5 个包络跟踪器 → 频带能量
  └── 检测器（×4）
        ├── STALTADetector   3 个时间尺度，能量 EMA，迟滞阈值
        ├── CUSUMDetector    双向，自适应基线
        ├── KurtosisDetector 100 样本窗口，阈值 K > 6
        └── PeakMADDetector  200 样本窗口，1.4826 × MAD → σ
        │
        ▼
SwiftUI 视图（@Published，主线程）
  ├── WaveformView     Canvas 实时波形，60 fps（TimelineView）
  ├── OrientationView  横滚 / 俯仰 / 偏航仪表 + 人工地平仪
  ├── SpectralView     Swift Charts 五频带柱状图
  └── EventLogView     按严重度着色的事件日志（含检测器来源标签）
```

---

## 环境要求与设置

| 要求 | 详情 |
|------|------|
| 硬件 | Apple Silicon MacBook（M1 / M2 / M3 / M4） |
| macOS | 14.0 Sonoma 或更高版本 |
| Xcode | 15.0 或更高版本（Swift 5.9+） |
| 沙盒 | **已禁用** —— IOKit HID 硬件访问必须关闭沙盒 |
| 权限 | **输入监控**（系统设置 → 隐私与安全性 → 输入监控） |

### 编译

```bash
xcodebuild -project apple-motion.xcodeproj \
           -scheme apple-motion \
           -destination "platform=macOS" \
           build
```

或在 Xcode 中打开 `apple-motion.xcodeproj`，按 **⌘R** 运行。

### 权限授权

首次启动时，若尚未授予输入监控权限：

1. 应用显示提示对话框。
2. 点击**打开系统设置**。
3. 导航至**隐私与安全性 → 输入监控**。
4. 开启 **apple-motion**。
5. 重新启动应用。

---

## 已知限制

| 限制 | 说明 |
|------|------|
| **未公开 API** | `AppleSPUHIDDevice` 是 Apple 私有接口，报告格式或设备 Usage 可能在未来 macOS 版本中变更 |
| **无磁力计** | 偏航角（Yaw）缺乏绝对方位参考，会随时间缓慢漂移 |
| **不支持 App Store** | 关闭沙盒后无法通过 Mac App Store 分发 |
| **ALS / 合盖角度** | 部分 MacBook 型号可能不存在该传感器或始终报告 0 |
| **Intel Mac** | 不支持 —— SPU 子系统为 Apple Silicon 专属 |

---

## 致谢

传感器访问方法和 HID 报告格式参考自
[olvvier/apple-silicon-accelerometer](https://github.com/olvvier/apple-silicon-accelerometer)（Python 参考实现）。
